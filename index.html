<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>SimPrÃ©stamo</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,700;0,900;1,700&family=DM+Sans:wght@300;400;500;600&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     TEMA DINÃMICO â€” se aplica ANTES de renderizar body
     Lee TelefonoAdmin: IdAdmin|NombreEmpresa|TelefonoAdmin|Email|Activo|logoEmpresa|ColorPrimario
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script>
(async function(){
  const SID='19Viesr9Lhy347A9L03J_RuxftUhBduaYsBY206IO6X8';
  const ds=document.documentElement.style;

  function applyColor(hex){
    if(!hex||!/^#[0-9a-fA-F]{6}$/.test(hex)) return;
    const r=parseInt(hex.slice(1,3),16),g=parseInt(hex.slice(3,5),16),b=parseInt(hex.slice(5,7),16);
    ds.setProperty('--primary',hex);
    ds.setProperty('--primary-dk',`rgb(${Math.round(r*.76)},${Math.round(g*.76)},${Math.round(b*.76)})`);
    ds.setProperty('--primary-a',`rgba(${r},${g},${b},.14)`);
    ds.setProperty('--primary-glow',`rgba(${r},${g},${b},.28)`);
  }

  // 1. CachÃ© inmediata (sin esperar red)
  try{
    const c=localStorage.getItem('sp_tema');
    if(c){const t=JSON.parse(c);if(Date.now()-t.ts<5*60*1000){applyColor(t.color);return;}}
  }catch(_){}

  // 2. Fetch fresco
  try{
    const url=`https://docs.google.com/spreadsheets/d/${SID}/gviz/tq?tqx=out:json&sheet=TelefonoAdmin&t=${Date.now()}`;
    const txt=await(await fetch(url,{cache:'no-store'})).text();
    const rows=JSON.parse(txt.replace(/^[\s\S]*?setResponse\(/,'').replace(/\);[\s\S]*$/,'')).table?.rows||[];
    for(let i=1;i<rows.length;i++){
      const c=rows[i]?.c||[];
      if(String(c[4]?.v||'').toUpperCase()!=='TRUE') continue;
      const t={
        ts:      Date.now(),
        empresa: String(c[1]?.v||'').trim(),
        tel:     String(c[2]?.v||'').trim(),
        email:   String(c[3]?.v||'').trim(),
        logo:    String(c[5]?.v||'').trim(),
        color:   String(c[6]?.v||'').trim(),
      };
      localStorage.setItem('sp_tema',JSON.stringify(t));
      // Guardar telÃ©fono para solicitud.html
      if(t.tel){
        const n=t.tel.replace(/\D/g,'');
        const clean=n.startsWith('52')&&n.length===12?n:n.length===10?'52'+n:n;
        localStorage.setItem('simulador_admin',JSON.stringify({data:{telefono:clean,email:t.email},ts:Date.now()}));
      }
      applyColor(t.color);
      // Nombre + logo se aplican en DOMContentLoaded
      if(t.empresa||t.logo){
        document.addEventListener('DOMContentLoaded',()=>{
          const logo=document.querySelector('.logo');
          if(!logo) return;
          if(t.empresa){
            const n=t.empresa,m=Math.ceil(n.length/2);
            logo.innerHTML=`${n.slice(0,m)}<em>${n.slice(m)}</em>`;
            document.title=t.empresa;
          }
          if(t.logo&&t.logo.startsWith('http')){
            const img=document.createElement('img');
            img.src=t.logo;img.alt='';
            img.style.cssText='width:30px;height:30px;border-radius:8px;object-fit:contain;border:1px solid var(--b2);vertical-align:middle;margin-right:8px;';
            img.onload=()=>{
              logo.insertBefore(img,logo.firstChild);
              // Ocultar texto solo si hay logo
              if(t.logo&&!t.empresa) logo.querySelectorAll('span,em').forEach(e=>e.style.display='none');
            };
          }
        });
      }
      return;
    }
  }catch(e){console.warn('[tema]',e);}
})();
</script>

<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOKENS  â€”  Azul zafiro Â· Blanco Â· Naranja Â· Dorado
   --primary* se inyectan desde TelefonoAdmin â†‘
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root{
  /* Fondos */
  --bg:   #030911;
  --surf: #060f1e;
  --card: #091627;
  --card2:#0d1e32;
  --b1:   #122038;
  --b2:   #193254;
  --b3:   #1f3e6a;

  /* Azul primario (dinÃ¡mico) */
  --primary:      #1e72d8;
  --primary-dk:   #1558af;
  --primary-a:    rgba(30,114,216,.14);
  --primary-glow: rgba(30,114,216,.28);

  /* Naranja â€” procesos / acciones */
  --orange:  #f97316;
  --orange2: #dd620e;
  --orange-a:rgba(249,115,22,.13);

  /* Dorado â€” montos de dinero */
  --gold:  #f5bc45;
  --gold2: #d9a030;
  --gold-a:rgba(245,188,69,.12);

  /* Estado */
  --red:   #ef4444;
  --green: #22c55e;

  /* Texto */
  --txt:  #e0eaf8;
  --txt2: #a4bedc;
  --mid:  #5a7ea8;
  --soft: #334f72;
  --mut:  #1a2e48;

  --r:  14px;
  --rs: 9px;
}

/* â”€â”€ RESET â”€â”€ */
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{font-size:16px;-webkit-tap-highlight-color:transparent}
body{
  font-family:'DM Sans',sans-serif;
  background:var(--bg);color:var(--txt);
  min-height:100dvh;overflow-x:hidden;
}

/* â”€â”€ FONDO ATMOSFÃ‰RICO â”€â”€ */
body::before{
  content:'';position:fixed;inset:0;z-index:0;pointer-events:none;
  background:
    radial-gradient(ellipse 65% 50% at -6% -6%,
      rgba(30,114,216,.2) 0%,transparent 55%),
    radial-gradient(ellipse 50% 60% at 106% 106%,
      rgba(30,114,216,.12) 0%,transparent 52%),
    radial-gradient(ellipse 35% 30% at 50% 0%,
      rgba(245,188,69,.04) 0%,transparent 60%);
  animation:atm 11s ease-in-out infinite alternate;
}
@keyframes atm{from{opacity:1}to{opacity:.6}}

/* â”€â”€ TRAMA â”€â”€ */
body::after{
  content:'';position:fixed;inset:0;z-index:0;pointer-events:none;opacity:.018;
  background-image:
    linear-gradient(rgba(120,170,255,1) 1px,transparent 1px),
    linear-gradient(90deg,rgba(120,170,255,1) 1px,transparent 1px);
  background-size:52px 52px;
}

.app{position:relative;z-index:1;max-width:430px;margin:0 auto;padding:0 16px 60px}

/* â•â• HEADER â•â• */
.hdr{display:flex;align-items:center;justify-content:space-between;padding:22px 0 6px}
.logo{
  font-family:'Playfair Display',serif;
  font-weight:900;font-size:1.32rem;
  letter-spacing:-.02em;line-height:1;
  color:var(--txt);
}
.logo em{
  color:var(--primary);font-style:normal;
  text-shadow:0 0 24px var(--primary-glow);
  transition:color .3s,text-shadow .3s;
}

/* â”€â”€ STATUS DOT â”€â”€ */
.sdot{
  width:8px;height:8px;border-radius:50%;
  background:var(--mut);transition:background .4s,box-shadow .4s;
}
.sdot.ok  {background:var(--green);box-shadow:0 0 8px rgba(34,197,94,.5);}
.sdot.off {background:var(--orange);box-shadow:0 0 8px rgba(249,115,22,.4);}
.sdot.busy{background:var(--primary);animation:pulse .9s infinite;box-shadow:0 0 10px var(--primary-glow);}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.2}}

/* â•â• SYNC STRIP â•â• */
.sw{height:2px;border-radius:99px;background:var(--b1);overflow:hidden;margin-bottom:6px}
.sf{
  height:100%;width:0%;border-radius:99px;
  background:linear-gradient(90deg,var(--primary),var(--orange),var(--gold));
  transition:width .35s,opacity .4s;opacity:0;
}
.sf.on{opacity:1}

/* â•â• BANNER INFO â•â• */
.banner{
  display:none;align-items:center;gap:9px;
  margin:4px 0 10px;padding:11px 14px;
  border-radius:var(--rs);
  background:var(--primary-a);
  border:1px solid rgba(30,114,216,.22);
  font-size:.83rem;color:var(--txt2);
}
.banner.show{display:flex}

/* â•â• BANNER ACTUALIZACIÃ“N â•â• */
.banner-upd{
  display:none;flex-direction:column;gap:4px;
  margin:4px 0 10px;padding:11px 14px;
  border-radius:var(--rs);
  background:var(--gold-a);
  border:1px solid rgba(245,188,69,.28);
  font-size:.78rem;color:var(--gold);line-height:1.55;
}
.banner-upd.show{display:flex}
.banner-upd strong{font-family:'Playfair Display',serif;font-size:.82rem;}

/* â•â• SECTION LABEL â•â• */
.slabel{
  font-family:'Playfair Display',serif;
  font-size:.68rem;font-weight:700;
  letter-spacing:.1em;text-transform:uppercase;
  color:var(--mid);margin:22px 0 10px;
}

/* â•â• CARD â•â• */
.card{
  background:var(--card);border:1px solid var(--b1);
  border-radius:var(--r);padding:20px;
  box-shadow:0 6px 28px rgba(0,0,0,.4),0 1px 0 rgba(255,255,255,.02) inset;
  position:relative;overflow:hidden;
}
.card::before{
  content:'';position:absolute;top:0;left:14%;right:14%;height:1px;
  background:linear-gradient(90deg,transparent,rgba(30,114,216,.3),transparent);
}

/* â•â• CHIP LABEL â•â• */
.clabel{
  font-size:.74rem;font-weight:500;color:var(--mid);
  display:flex;align-items:center;gap:6px;margin-bottom:10px;
}
.clabel svg{opacity:.6}

/* â•â• CHIPS â•â• */
.chips{display:flex;flex-wrap:wrap;gap:7px;margin-bottom:20px}
.chips.g{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}

.chip{
  padding:8px 16px;border-radius:99px;
  border:1.5px solid var(--b2);background:var(--surf);
  color:var(--soft);font-size:.82rem;font-weight:500;
  cursor:pointer;user-select:none;-webkit-user-select:none;
  transition:border-color .13s,background .13s,color .13s,transform .1s,box-shadow .13s;
  position:relative;overflow:hidden;
}
.chip::before{
  content:'';position:absolute;inset:0;
  background:linear-gradient(135deg,rgba(255,255,255,.03) 0%,transparent 55%);
}
.chips.g .chip{border-radius:var(--rs);text-align:center;padding:10px 4px}
.chip:active{transform:scale(.96)}

/* Plazo â†’ azul al hover/select */
.chip:hover{
  border-color:var(--primary);color:var(--txt2);
  background:var(--primary-a);
}
.chip.on{
  border-color:var(--primary);
  background:linear-gradient(135deg,var(--primary-a),rgba(30,114,216,.07));
  color:var(--primary);font-weight:600;
  box-shadow:0 0 0 1px var(--primary-a),0 4px 14px var(--primary-glow);
}

/* Capital â†’ dorado al hover/select */
.chips.g .chip:hover{
  border-color:var(--gold);color:var(--gold);background:var(--gold-a);
}
.chips.g .chip.on{
  border-color:var(--gold);
  background:linear-gradient(135deg,var(--gold-a),rgba(245,188,69,.06));
  color:var(--gold);font-weight:600;
  box-shadow:0 0 0 1px var(--gold-a),0 4px 14px rgba(245,188,69,.24);
}

/* â”€â”€ SKELETON â”€â”€ */
.sk{
  background:linear-gradient(90deg,var(--surf) 25%,var(--card2) 50%,var(--surf) 75%);
  background-size:200% 100%;animation:sh 1.2s infinite;
  border-radius:99px;height:36px;
}
.chips.g .sk{border-radius:var(--rs)}
@keyframes sh{0%{background-position:200% 0}100%{background-position:-200% 0}}

.divider{height:1px;background:var(--b1);margin:0 0 20px}

/* â•â• RESULTADO â•â• */
.rp{
  margin-top:20px;border-radius:var(--r);overflow:hidden;
  border:1px solid var(--b2);background:var(--card2);
  transition:border-color .3s,box-shadow .3s;
}
.rp.on{
  border-color:rgba(245,188,69,.3);
  box-shadow:
    0 0 0 1px rgba(245,188,69,.06),
    0 8px 32px rgba(0,0,0,.5),
    0 0 48px rgba(30,114,216,.05);
}

/* Cabecera resultado */
.rh{
  padding:20px 20px 14px;text-align:center;
  background:linear-gradient(150deg,rgba(30,114,216,.07) 0%,rgba(245,188,69,.04) 100%);
  border-bottom:1px solid var(--b1);transition:background .3s;
  position:relative;overflow:hidden;
}
.rh::before{
  content:'';position:absolute;top:0;left:0;right:0;height:2px;
  background:linear-gradient(90deg,transparent,rgba(245,188,69,.4),rgba(249,115,22,.25),transparent);
  opacity:0;transition:opacity .3s;
}
.rh.on::before{opacity:1}
.rh.on{background:linear-gradient(150deg,rgba(30,114,216,.1) 0%,rgba(245,188,69,.07) 100%)}

.rl{font-size:.66rem;color:var(--soft);letter-spacing:.1em;text-transform:uppercase;margin-bottom:6px}

/* Total â†’ dorado cuando activo */
.rb{
  font-family:'Playfair Display',serif;
  font-size:2.4rem;font-weight:900;
  letter-spacing:-.03em;line-height:1;
  color:var(--mut);transition:color .22s,text-shadow .22s;
}
.rb.on{
  color:var(--gold);
  text-shadow:0 2px 24px rgba(245,188,69,.28);
}

.rs{font-size:.76rem;color:var(--mut);margin-top:5px;min-height:1.2em;transition:color .2s}
.rs.on{color:var(--mid)}

/* Grid detalle */
.rg{display:grid;grid-template-columns:1fr 1fr}
.ri{padding:14px 16px;border-right:1px solid var(--b1);border-bottom:1px solid var(--b1)}
.ri:nth-child(2n){border-right:none}
.ri:nth-last-child(-n+2){border-bottom:none}
.rik{font-size:.65rem;color:var(--soft);text-transform:uppercase;letter-spacing:.07em;margin-bottom:4px}
.riv{
  font-family:'JetBrains Mono',monospace;
  font-size:1.02rem;font-weight:600;
  color:var(--mut);transition:color .2s;
}
.riv.v    {color:var(--txt2)}
.riv.v.ac {color:var(--primary)}   /* tasa & pago diario â†’ azul */
.riv.v.go {color:var(--gold)}      /* interÃ©s â†’ dorado */

.rf{
  display:flex;align-items:center;justify-content:center;gap:6px;
  padding:8px;background:rgba(0,0,0,.18);
  font-size:.66rem;color:var(--soft);min-height:30px;
  border-top:1px solid var(--b1);
}
.rfd{width:4px;height:4px;border-radius:50%;background:var(--gold);opacity:0;transition:opacity .3s}
.rfd.v{opacity:1;box-shadow:0 0 7px rgba(245,188,69,.55)}

/* â•â• EMPTY / TOAST â•â• */
.empty{padding:20px 0;text-align:center;font-size:.81rem;color:var(--soft);line-height:1.7}
.empty span{font-size:1.7rem;display:block;margin-bottom:7px;opacity:.35}

#toast{
  position:fixed;bottom:20px;left:50%;
  transform:translateX(-50%) translateY(52px);
  background:var(--card2);border:1px solid var(--b2);
  padding:9px 18px;border-radius:99px;
  font-size:.8rem;color:var(--txt);
  box-shadow:0 8px 24px rgba(0,0,0,.5);
  transition:transform .3s cubic-bezier(.34,1.56,.64,1);
  white-space:nowrap;z-index:200;pointer-events:none;
}
#toast.show{transform:translateX(-50%) translateY(0)}

/* â•â• FAB COMPARTIR â€” azul primario â•â• */
.fab-cmp{
  position:fixed;bottom:82px;right:16px;z-index:100;
  width:52px;height:52px;border-radius:50%;
  background:linear-gradient(135deg,var(--primary),var(--primary-dk));
  border:none;cursor:pointer;
  display:flex;align-items:center;justify-content:center;
  box-shadow:0 6px 24px var(--primary-glow),0 2px 8px rgba(0,0,0,.4);
  transition:transform .15s,box-shadow .15s;
  animation:fabIn .5s .1s cubic-bezier(.34,1.56,.64,1) both;
}
.fab-cmp:hover{transform:scale(1.1);box-shadow:0 10px 32px var(--primary-glow)}
.fab-cmp:active{transform:scale(.95)}
.fab-cmp-tip{
  position:fixed;bottom:84px;right:78px;z-index:100;
  background:var(--card2);border:1px solid var(--b2);
  color:var(--txt);font-size:.75rem;font-family:'DM Sans',sans-serif;
  padding:7px 12px;border-radius:99px;
  white-space:nowrap;pointer-events:none;
  box-shadow:0 4px 16px rgba(0,0,0,.4);
  opacity:0;transform:translateX(8px);
  transition:opacity .2s,transform .2s;
}
.fab-cmp:hover + .fab-cmp-tip,
.fab-cmp-tip:hover{opacity:1;transform:translateX(0)}

/* â•â• FAB SOLICITAR â€” naranja â•â• */
.fab-sol{
  position:fixed;bottom:20px;right:16px;z-index:100;
  width:52px;height:52px;border-radius:50%;
  background:linear-gradient(135deg,var(--orange),var(--orange2));
  border:none;cursor:pointer;
  display:flex;align-items:center;justify-content:center;
  box-shadow:0 6px 24px rgba(249,115,22,.42),0 2px 8px rgba(0,0,0,.4);
  transition:transform .15s,box-shadow .15s;
  animation:fabIn .5s cubic-bezier(.34,1.56,.64,1) both;
}
.fab-sol:hover{transform:scale(1.1);box-shadow:0 10px 32px rgba(249,115,22,.55)}
.fab-sol:active{transform:scale(.95)}
@keyframes fabIn{from{transform:scale(0);opacity:0}to{transform:scale(1);opacity:1}}
.fab-sol-tip{
  position:fixed;bottom:22px;right:78px;z-index:100;
  background:var(--card2);border:1px solid var(--b2);
  color:var(--txt);font-size:.75rem;font-family:'DM Sans',sans-serif;
  padding:7px 12px;border-radius:99px;
  white-space:nowrap;pointer-events:none;
  box-shadow:0 4px 16px rgba(0,0,0,.4);
  opacity:0;transform:translateX(8px);
  transition:opacity .2s,transform .2s;
}
.fab-sol:hover + .fab-sol-tip,
.fab-sol-tip:hover{opacity:1;transform:translateX(0)}

/* â•â• RESPONSIVE â•â• */
@media(max-width:360px){
  .rb{font-size:2rem}
  .chips.g{grid-template-columns:repeat(2,1fr)}
}
</style>
</head>
<body>
<div class="app">
  <header class="hdr">
    <div class="logo">Sim<em>PrÃ©stamo</em></div>
    <div class="sdot" id="sdot"></div>
  </header>
  <div class="sw"><div class="sf" id="strip"></div></div>
  <div class="banner" id="banner"><span>ğŸ“¢</span><span id="bannerTxt"></span></div>
  <div class="banner-upd" id="bannerUpd">
    <strong>âš ï¸ Tarifas actualizadas</strong>
    Las condiciones pueden cambiar sin previo aviso. Para cualquier aclaraciÃ³n contacta con tu asesor de servicios.
  </div>
  <p class="slabel">Simulador de prÃ©stamo</p>
  <div class="card">
    <div class="clabel">
      <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2">
        <rect x="3" y="4" width="18" height="18" rx="2"/>
        <line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/>
        <line x1="3" y1="10" x2="21" y2="10"/>
      </svg>
      Plazo
    </div>
    <div class="chips" id="chipsDias">
      <div class="sk" style="width:76px"></div>
      <div class="sk" style="width:76px"></div>
      <div class="sk" style="width:76px"></div>
    </div>
    <div class="divider"></div>
    <div class="clabel">
      <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2">
        <line x1="12" y1="1" x2="12" y2="23"/>
        <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 7H6"/>
      </svg>
      Capital solicitado
    </div>
    <div class="chips g" id="chipsCapital">
      <div class="sk"></div><div class="sk"></div><div class="sk"></div>
      <div class="sk"></div><div class="sk"></div><div class="sk"></div>
    </div>
    <div class="rp" id="rp">
      <div class="rh" id="rh">
        <div class="rl">Total a pagar</div>
        <div class="rb" id="rTotal">â€”</div>
        <div class="rs" id="rSub">Selecciona plazo y capital</div>
      </div>
      <div class="rg">
        <div class="ri"><div class="rik">Capital</div><div class="riv" id="rCap">â€”</div></div>
        <div class="ri"><div class="rik">Tasa</div><div class="riv" id="rTasa">â€”</div></div>
        <div class="ri"><div class="rik">InterÃ©s total</div><div class="riv" id="rInt">â€”</div></div>
        <div class="ri"><div class="rik">Pago diario</div><div class="riv" id="rDia">â€”</div></div>
      </div>
      <div class="rf">
        <div class="rfd" id="rDot"></div>
        <span id="rFoot">Esperando selecciÃ³nâ€¦</span>
      </div>
    </div>
  </div>
</div>
<div id="toast"></div>

<!-- BOTÃ“N FLOTANTE â†’ compartir.html -->
<button class="fab-cmp" onclick="window.location.href='compartir.html'" title="Compartir simulador">
  <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
    <circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/>
    <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/>
    <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/>
  </svg>
</button>
<div class="fab-cmp-tip">Compartir simulador</div>

<!-- BOTÃ“N FLOTANTE â†’ solicitud.html -->
<button class="fab-sol" onclick="abrirSolicitud()" title="Enviar solicitud">
  <svg width="24" height="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
    <path fill="white" d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.890-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/>
  </svg>
</button>
<div class="fab-sol-tip">Solicitar prÃ©stamo</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     TODO EL JS ORIGINAL â€” sin cambiar ni una coma
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script>
function abrirSolicitud(){
  // Verificar que haya una simulaciÃ³n activa
  const sel = (() => { try{ return JSON.parse(sessionStorage.getItem('sp_sel')||'{}'); }catch(e){ return {}; } })();
  if (!sel.dias || !sel.capital) {
    // Mostrar toast del index
    const el = document.getElementById('toast');
    el.textContent = 'Selecciona plazo y capital primero';
    el.classList.add('show');
    setTimeout(() => el.classList.remove('show'), 2800);
    return;
  }
  window.location.href = 'solicitud.html';
}
</script>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SERVICE WORKER â€” apunta a sw.js real
   (Blob URL no funciona en GitHub Pages)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./sw.js', { scope: './' }).catch(() => {});
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONFIG
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const SHEET_ID  = '19Viesr9Lhy347A9L03J_RuxftUhBduaYsBY206IO6X8';
const CACHE_TTL = 5 * 60 * 1000; // 5 minutos

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ESTADO GLOBAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let selDias    = null;
let selCapital = null;
let C = { dias:[], capital:[], interes:{}, banner:{activo:false,texto:''} };
let syncing = false;

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LOCALSTORAGE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function save(k,d){ localStorage.setItem('simulador_'+k,JSON.stringify({data:d,ts:Date.now()})); }
function load(k){
  try{
    const r=localStorage.getItem('simulador_'+k);
    if(!r) return null;
    const p=JSON.parse(r);
    return ('data' in p) ? p.data : p;
  }catch(e){ return null; }
}
function loadTs(k){
  try{ return JSON.parse(localStorage.getItem('simulador_'+k))?.ts||null; }catch(e){ return null; }
}
function cacheOk(){
  const d=load('dias'),c=load('capital'),i=load('interes');
  return Array.isArray(d)&&d.length>0&&Array.isArray(c)&&c.length>0&&i&&typeof i==='object'&&!Array.isArray(i)&&Object.keys(i).length>0;
}
function intoMem(){
  C.dias    = load('dias')    || [];
  C.capital = load('capital') || [];
  C.interes = load('interes') || {};
  C.banner  = load('banner')  || {activo:false,texto:''};
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   NORMALIZACIÃ“N
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function norm(v){
  if(typeof v==='number') return isFinite(v)?v:NaN;
  if(v==null||v==='') return NaN;
  let s=String(v).trim().replace(/%/g,'').replace(/,/g,'.');
  const p=s.split('.');
  if(p.length>2) s=p.slice(0,-1).join('')+'.'+p[p.length-1];
  const n=parseFloat(s);
  return isNaN(n)||!isFinite(n)?NaN:n;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FETCH SHEETS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function fetchSheet(nombre){
  const url=`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(nombre)}`;
  const r=await fetch(url,{cache:'no-store'});
  if(!r.ok) throw new Error(`HTTP ${r.status}`);
  const txt=await r.text();
  const json=JSON.parse(txt.replace(/^[\s\S]*?setResponse\(/,'').replace(/\);[\s\S]*$/,''));
  return json.table?.rows||[];
}
async function leerA(n){
  const rows=await fetchSheet(n); const vals=[];
  rows.forEach((row,i)=>{
    const v=row?.c?.[0]?.v;
    if(i===0&&isNaN(parseFloat(v))) return;
    const x=norm(v); if(!isNaN(x)) vals.push(x);
  });
  return vals;
}
async function leerInteres(dias){
  const rows=await fetchSheet('Interes'); const vals=[];
  rows.forEach((row,i)=>{
    const v=row?.c?.[0]?.v, f=row?.c?.[0]?.f||'';
    if(i===0&&isNaN(parseFloat(v))) return;
    let n=norm(v);
    if(isNaN(n)||n>1000) return;
    if(f.includes('%')||(n>0&&n<1)) n*=100;
    if(n<0||n>100) return;
    vals.push(n);
  });
  const obj={},len=Math.min(dias.length,vals.length);
  for(let i=0;i<len;i++) obj[dias[i]]=vals[i];
  return obj;
}
async function leerBanner(){
  try{
    const rows=await fetchSheet('Banner');
    if(rows.length>1){const t=rows[1]?.c?.[0]?.v||'';return{activo:t.trim()!=='',texto:t};}
  }catch(_){}
  return{activo:false,texto:''};
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SYNC SILENCIOSO
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function sync(){
  if(syncing||!navigator.onLine) return;
  syncing=true; dot('busy'); pct(8);
  try{
    // Snapshot de datos ANTES del sync para comparar
    const antesSnap = JSON.stringify({
      dias:    load('dias'),
      capital: load('capital'),
      interes: load('interes')
    });

    const dias=await leerA('Dias');
    if(!dias.length) throw new Error('Dias vacÃ­o');
    save('dias',dias); pct(30);

    const capital=await leerA('Capital');
    if(!capital.length) throw new Error('Capital vacÃ­o');
    save('capital',capital); pct(55);

    const interes=await leerInteres(dias);
    if(!Object.keys(interes).length) throw new Error('Interes vacÃ­o');
    save('interes',interes); pct(82);

    const banner=await leerBanner();
    save('banner',banner); pct(100);

    intoMem();
    paintDias(); paintCapital(); paintBanner();

    // Mostrar advertencia SOLO si los datos cambiaron respecto al cachÃ© anterior
    const despuesSnap = JSON.stringify({ dias, capital, interes });
    const huboCambios = antesSnap !== '{"dias":null,"capital":null,"interes":null}'
                        && antesSnap !== despuesSnap;
    if(huboCambios){
      gi('bannerUpd').classList.add('show');
    }

    calc();
    dot('ok'); setTimeout(()=>pct(null),500);
  }catch(err){
    dot(navigator.onLine?'ok':'off'); pct(null);
    if(!cacheOk()) toast('Error: '+err.message,4000);
  }
  syncing=false;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RENDER CHIPS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function paintDias(){
  const el=gi('chipsDias'); el.innerHTML='';
  if(!C.dias.length){ el.innerHTML='<div class="empty"><span>ğŸ“…</span>Cargandoâ€¦</div>'; return; }
  C.dias.forEach(d=>{
    const c=mk('div','chip'+(selDias===d?' on':''));
    c.textContent=d+' dÃ­as';
    c.addEventListener('click',()=>pickD(d));
    el.appendChild(c);
  });
}
function paintCapital(){
  const el=gi('chipsCapital'); el.innerHTML='';
  if(!C.capital.length){ el.innerHTML='<div class="empty"><span>ğŸ’°</span>Cargandoâ€¦</div>'; return; }
  C.capital.forEach(c=>{
    const chip=mk('div','chip'+(selCapital===c?' on':''));
    chip.textContent='$'+c.toLocaleString('es-MX');
    chip.addEventListener('click',()=>pickC(c));
    el.appendChild(chip);
  });
}
function paintBanner(){
  const b=C.banner;
  if(b?.activo&&b.texto?.trim()){gi('bannerTxt').textContent=b.texto;gi('banner').classList.add('show');}
  else gi('banner').classList.remove('show');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PICK
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function pickD(d){
  selDias=d;
  try{ const s=JSON.parse(sessionStorage.getItem('sp_sel')||'{}'); s.dias=d; sessionStorage.setItem('sp_sel',JSON.stringify(s)); }catch(e){}
  gi('chipsDias').querySelectorAll('.chip').forEach(c=>c.classList.toggle('on',parseInt(c.textContent)===d));
  calc();
}
function pickC(c){
  selCapital=c;
  try{ const s=JSON.parse(sessionStorage.getItem('sp_sel')||'{}'); s.capital=c; sessionStorage.setItem('sp_sel',JSON.stringify(s)); }catch(e){}
  gi('chipsCapital').querySelectorAll('.chip').forEach(el=>el.classList.toggle('on',el.textContent==='$'+c.toLocaleString('es-MX')));
  calc();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CÃLCULO
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function calc(){
  if(!selDias&&!selCapital){ reset('Selecciona plazo y capital'); return; }
  if(!selDias)              { reset('Selecciona un plazo');       return; }
  if(!selCapital)           { reset('Selecciona el capital');     return; }
  if(!C.interes||Object.keys(C.interes).length===0){ intoMem(); }
  const ip=C.interes[selDias];
  if(ip===undefined||ip===null){ reset('Sin tasa para ese plazo'); return; }
  const it=selCapital*(ip/100);
  const tp=selCapital+it;
  const pd=tp/selDias;
  showRes(selDias,selCapital,ip,it,tp,pd);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MOSTRAR / LIMPIAR RESULTADO
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function fmt(n){ return '$'+n.toLocaleString('es-MX',{minimumFractionDigits:2,maximumFractionDigits:2}); }
function showRes(dias,capital,ip,it,tp,pd){
  const hora=new Date().toLocaleTimeString('es-MX',{hour:'2-digit',minute:'2-digit'});
  gi('rp').classList.add('on'); gi('rh').classList.add('on');
  gi('rTotal').textContent=fmt(tp); gi('rTotal').classList.add('on');
  gi('rSub').textContent=`${dias} dÃ­as Â· tasa ${ip}%`; gi('rSub').classList.add('on');
  setV('rCap', fmt(capital),'',  '');
  setV('rTasa',ip+'%',     'ac','');
  setV('rInt', fmt(it),    '',  'go');
  setV('rDia', fmt(pd),    'ac','');
  gi('rDot').classList.add('v');
  gi('rFoot').textContent='Calculado con cachÃ© Â· '+hora;
}
function setV(id,val,ac,go){
  const el=gi(id); el.textContent=val;
  el.className='riv v'+(ac?' '+ac:'')+(go?' '+go:'');
}
function reset(msg){
  gi('rp').classList.remove('on'); gi('rh').classList.remove('on');
  gi('rTotal').textContent='â€”'; gi('rTotal').classList.remove('on');
  gi('rSub').textContent=msg; gi('rSub').classList.remove('on');
  ['rCap','rTasa','rInt','rDia'].forEach(id=>{ const el=gi(id); el.textContent='â€”'; el.className='riv'; });
  gi('rDot').classList.remove('v');
  gi('rFoot').textContent='Esperando selecciÃ³nâ€¦';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   UI UTILS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const gi=(id)=>document.getElementById(id);
const mk=(t,c)=>{ const e=document.createElement(t); if(c) e.className=c; return e; };
function dot(m){ gi('sdot').className='sdot '+(m||''); }
function pct(v){
  const f=gi('strip');
  if(v===null){ f.classList.remove('on'); setTimeout(()=>{f.style.width='0%';},400); return; }
  f.classList.add('on'); f.style.width=v+'%';
}
let _tT;
function toast(msg,ms=2800){
  clearTimeout(_tT);
  const el=gi('toast'); el.textContent=msg; el.classList.add('show');
  _tT=setTimeout(()=>el.classList.remove('show'),ms);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INIT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function init(){
  dot(navigator.onLine?'ok':'off');

  if(cacheOk()){
    intoMem();
    paintDias(); paintCapital(); paintBanner();
    // Restaurar selecciÃ³n previa (F5)
    try{
      const prev=JSON.parse(sessionStorage.getItem('sp_sel')||'{}');
      if(prev.dias    && C.dias.includes(prev.dias))       selDias=prev.dias;
      if(prev.capital && C.capital.includes(prev.capital)) selCapital=prev.capital;
      if(selDias)    gi('chipsDias').querySelectorAll('.chip').forEach(c=>c.classList.toggle('on',parseInt(c.textContent)===selDias));
      if(selCapital) gi('chipsCapital').querySelectorAll('.chip').forEach(c=>c.classList.toggle('on',c.textContent==='$'+selCapital.toLocaleString('es-MX')));
    }catch(e){}
    calc();
    // Sync silencioso si cachÃ© vencido
    const ts=loadTs('dias');
    if((!ts||(Date.now()-ts)>CACHE_TTL)&&navigator.onLine) sync();
  } else {
    if(navigator.onLine){
      await sync();
    } else {
      gi('chipsDias').innerHTML='<div class="empty"><span>ğŸ“µ</span>Sin conexiÃ³n.<br>Se cargarÃ¡ al reconectar.</div>';
      gi('chipsCapital').innerHTML='';
    }
  }

  window.addEventListener('online',()=>{
    dot('busy');
    sync().then(()=>{ if(cacheOk()){ intoMem(); paintDias(); paintCapital(); paintBanner(); calc(); } });
  });
  window.addEventListener('offline',()=>{ dot('off'); });
}

init();
</script>
</body>
</html>
