<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>SimPrÃ©stamo</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=DM+Sans:wght@300;400;500;600&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOKENS BASE â€” se sobreescriben con JS desde TelefonoAdmin
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root{
  /* Paleta azul elegante */
  --bg:        #050d1a;
  --bg2:       #071023;
  --surf:      #0a1628;
  --card:      #0c1b30;
  --card2:     #0f2038;
  --b1:        #142840;
  --b2:        #1a3350;
  --b3:        #1e3d60;

  /* Acentos */
  --primary:   #1a6fd4;   /* Azul primario - dinÃ¡mico desde TelefonoAdmin */
  --primary2:  #1557b0;
  --primary3:  rgba(26,111,212,.12);

  --orange:    #f97316;   /* Naranja â€” procesos, CTAs */
  --orange2:   #ea6c0c;
  --orange3:   rgba(249,115,22,.12);

  --gold:      #f4b942;   /* Dorado â€” montos de dinero */
  --gold2:     #d9a235;
  --gold3:     rgba(244,185,66,.12);

  --red:       #ef4444;
  --red3:      rgba(239,68,68,.1);
  --green:     #22c55e;

  /* Texto */
  --txt:       #e8f0fa;
  --txt2:      #b8cde8;
  --mid:       #7a9cc0;
  --soft:      #4a6a90;
  --mut:       #2a4060;

  --r:   14px;
  --rs:  10px;
  --rxs:  7px;

  --font-title: 'Playfair Display', serif;
  --font-body:  'DM Sans', sans-serif;
  --font-mono:  'JetBrains Mono', monospace;
}

*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{font-size:15px;-webkit-tap-highlight-color:transparent}
body{
  font-family:var(--font-body);
  background:var(--bg);
  color:var(--txt);
  min-height:100dvh;
  overflow-x:hidden;
}

/* FONDO ANIMADO */
body::before{
  content:'';position:fixed;inset:0;z-index:0;pointer-events:none;
  background:
    radial-gradient(ellipse 80% 60% at -10% -10%,rgba(26,111,212,.18) 0%,transparent 55%),
    radial-gradient(ellipse 60% 50% at 110% 110%,rgba(26,111,212,.1) 0%,transparent 50%),
    radial-gradient(ellipse 40% 40% at 50% 50%,rgba(244,185,66,.04) 0%,transparent 60%);
  animation:bgPulse 8s ease-in-out infinite alternate;
}
@keyframes bgPulse{
  from{opacity:1}to{opacity:.7}
}

/* PATRÃ“N DE LÃNEAS SUTILES */
body::after{
  content:'';position:fixed;inset:0;z-index:0;pointer-events:none;
  opacity:.025;
  background-image:
    linear-gradient(rgba(100,160,255,.8) 1px,transparent 1px),
    linear-gradient(90deg,rgba(100,160,255,.8) 1px,transparent 1px);
  background-size:56px 56px;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• LAYOUT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.wrap{
  position:relative;z-index:1;
  max-width:420px;margin:0 auto;
  padding:0 16px 100px;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• HEADER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.hdr{
  display:flex;align-items:center;justify-content:space-between;
  padding:20px 0 0;
  margin-bottom:4px;
}
.logo-area{display:flex;flex-direction:column;gap:2px;}
.logo-brand{
  display:flex;align-items:center;gap:10px;
}
.logo-img{
  width:36px;height:36px;border-radius:10px;
  object-fit:contain;background:var(--card);
  border:1px solid var(--b2);
  display:none;
}
.logo-img.show{display:block;}
.logo{
  font-family:var(--font-title);
  font-size:1.5rem;font-weight:900;
  letter-spacing:-.02em;line-height:1;
  color:var(--txt);
}
.logo em{
  color:var(--primary);font-style:normal;
  text-shadow:0 0 24px rgba(26,111,212,.4);
}
.logo-tagline{
  font-size:.62rem;color:var(--soft);
  letter-spacing:.1em;text-transform:uppercase;
  margin-top:2px;
}
.status-dot{
  width:8px;height:8px;border-radius:50%;
  transition:background .4s;
  flex-shrink:0;
}
.status-dot.ok{background:var(--green);}
.status-dot.off{background:var(--orange);}
.status-dot.busy{background:var(--primary);animation:blink .9s infinite;}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• HERO CARD â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.hero{
  background:var(--card);
  border:1px solid var(--b1);
  border-radius:20px;
  padding:22px;
  margin:18px 0 6px;
  position:relative;overflow:hidden;
}
.hero::before{
  content:'';position:absolute;top:0;left:0;right:0;height:2px;
  background:linear-gradient(90deg,var(--primary),var(--orange),var(--gold));
}
.hero-eyebrow{
  font-size:.62rem;letter-spacing:.14em;text-transform:uppercase;
  color:var(--primary);font-weight:600;margin-bottom:8px;
  display:flex;align-items:center;gap:6px;
}
.hero-eyebrow::before{content:'';width:18px;height:1.5px;background:var(--primary);border-radius:99px;}
.hero-title{
  font-family:var(--font-title);
  font-size:1.8rem;font-weight:900;
  line-height:1.1;letter-spacing:-.02em;
  color:var(--txt);margin-bottom:8px;
}
.hero-title em{color:var(--gold);font-style:normal;}
.hero-sub{font-size:.8rem;color:var(--mid);line-height:1.6;margin-bottom:16px;}
.hero-stats{
  display:grid;grid-template-columns:repeat(3,1fr);
  gap:10px;padding-top:14px;border-top:1px solid var(--b1);
}
.hstat{text-align:center;}
.hstat-val{
  font-family:var(--font-mono);font-size:1rem;font-weight:600;
  color:var(--gold);letter-spacing:-.02em;
}
.hstat-lbl{font-size:.6rem;color:var(--mut);text-transform:uppercase;letter-spacing:.08em;margin-top:1px;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SELECTOR LABEL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.sel-label{
  font-family:var(--font-title);
  font-size:.82rem;font-weight:700;
  color:var(--txt2);
  margin:20px 0 10px;
  display:flex;align-items:center;gap:8px;
}
.sel-label::after{content:'';flex:1;height:1px;background:var(--b1);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• CHIPS (selector) â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.chips{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:4px;}
.chip{
  padding:8px 16px;border-radius:99px;
  background:var(--card);border:1.5px solid var(--b2);
  color:var(--mid);font-size:.82rem;font-weight:500;
  cursor:pointer;transition:all .18s cubic-bezier(.34,1.56,.64,1);
  -webkit-tap-highlight-color:transparent;
  position:relative;overflow:hidden;white-space:nowrap;
}
.chip::before{
  content:'';position:absolute;inset:0;
  background:linear-gradient(135deg,rgba(255,255,255,.06) 0%,transparent 60%);
}
.chip:hover{border-color:var(--primary);color:var(--txt);}
.chip.sel{
  background:linear-gradient(135deg,var(--primary) 0%,var(--primary2) 100%);
  border-color:var(--primary);color:#fff;
  box-shadow:0 4px 16px rgba(26,111,212,.35);
  transform:scale(1.04);
}
.chip-loading{
  width:70px;height:38px;border-radius:99px;
  background:linear-gradient(90deg,var(--surf) 25%,var(--card2) 50%,var(--surf) 75%);
  background-size:200% 100%;animation:sk 1.3s infinite;
}
@keyframes sk{0%{background-position:200% 0}100%{background-position:-200% 0}}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• RESULT CARD â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.result{
  background:var(--card);border:1px solid var(--b1);
  border-radius:20px;padding:0;overflow:hidden;
  margin-top:18px;
  transition:opacity .3s,transform .3s;
  display:none;
}
.result.show{display:block;animation:fadeUp .4s cubic-bezier(.34,1.56,.64,1) both;}
@keyframes fadeUp{from{opacity:0;transform:translateY(14px)}to{opacity:1;transform:translateY(0)}}

/* BANNER TOTAL */
.result-banner{
  background:linear-gradient(135deg,var(--card2) 0%,var(--surf) 100%);
  padding:20px 22px;
  border-bottom:1px solid var(--b1);
  position:relative;overflow:hidden;
}
.result-banner::before{
  content:'';position:absolute;top:0;left:0;right:0;height:2px;
  background:linear-gradient(90deg,var(--gold),var(--orange));
}
.result-banner::after{
  content:'';position:absolute;right:-20px;top:-20px;
  width:100px;height:100px;border-radius:50%;
  background:radial-gradient(circle,rgba(244,185,66,.08) 0%,transparent 70%);
}
.rb-label{font-size:.62rem;letter-spacing:.12em;text-transform:uppercase;color:var(--soft);margin-bottom:4px;}
.rb-amount{
  font-family:var(--font-title);font-size:2.8rem;font-weight:900;
  letter-spacing:-.04em;line-height:1;
  color:var(--gold);
  text-shadow:0 2px 20px rgba(244,185,66,.3);
}
.rb-amount em{font-size:1.4rem;font-style:normal;opacity:.7;vertical-align:top;margin-top:8px;display:inline-block;}
.rb-pd{
  margin-top:8px;font-size:.8rem;color:var(--mid);
}
.rb-pd span{color:var(--orange);font-weight:600;font-family:var(--font-mono);}

/* DETALLE GRID */
.result-detail{
  display:grid;grid-template-columns:1fr 1fr 1fr;
  padding:16px 22px;gap:0;
}
.rd-item{
  padding:10px 0;
  border-right:1px solid var(--b1);
}
.rd-item:last-child{border-right:none;}
.rd-item{padding-left:14px;}
.rd-item:first-child{padding-left:0;}
.rd-lbl{font-size:.6rem;color:var(--mut);text-transform:uppercase;letter-spacing:.08em;margin-bottom:3px;}
.rd-val{font-family:var(--font-mono);font-size:.88rem;font-weight:600;color:var(--txt);}
.rd-val.blue{color:var(--primary);}
.rd-val.gold{color:var(--gold);}
.rd-val.orange{color:var(--orange);}

/* TABLA PAGO DIARIO */
.result-table{
  padding:0 22px 16px;border-top:1px solid var(--b1);
}
.rt-title{
  font-size:.62rem;color:var(--soft);letter-spacing:.1em;text-transform:uppercase;
  padding:12px 0 8px;margin-bottom:0;
}
.rt-row{
  display:flex;justify-content:space-between;align-items:center;
  padding:7px 0;border-bottom:1px solid rgba(20,40,64,.5);
  font-size:.8rem;
}
.rt-row:last-child{border-bottom:none;}
.rt-row-key{color:var(--mid);}
.rt-row-val{font-family:var(--font-mono);font-weight:600;}
.rt-row-val.gold{color:var(--gold);}
.rt-row-val.orange{color:var(--orange);}
.rt-row-val.blue{color:var(--primary);}

/* EMPTY STATE */
.empty{
  background:var(--card);border:1px solid var(--b1);border-radius:20px;
  padding:32px 22px;text-align:center;margin-top:18px;
}
.empty-icon{font-size:2.5rem;margin-bottom:12px;opacity:.4;}
.empty-txt{font-size:.82rem;color:var(--soft);line-height:1.7;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• BANNER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.info-banner{
  display:none;align-items:flex-start;gap:10px;
  padding:12px 14px;background:var(--orange3);
  border:1px solid rgba(249,115,22,.25);border-radius:var(--r);
  font-size:.75rem;color:#fdba74;line-height:1.6;
  margin-top:14px;
}
.info-banner.show{display:flex;}
.info-banner svg{flex-shrink:0;margin-top:1px;color:var(--orange);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• TOAST â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#toast{
  position:fixed;bottom:88px;left:50%;transform:translateX(-50%) translateY(60px);
  background:var(--card2);border:1px solid var(--b2);
  padding:9px 20px;border-radius:99px;
  font-size:.78rem;color:var(--txt);
  box-shadow:0 8px 24px rgba(0,0,0,.5);
  transition:transform .3s cubic-bezier(.34,1.56,.64,1);
  white-space:nowrap;z-index:200;pointer-events:none;
  max-width:calc(100vw - 32px);
}
#toast.show{transform:translateX(-50%) translateY(0);}
#toast.ok{border-color:rgba(34,197,94,.3);color:var(--green);}
#toast.err{border-color:rgba(239,68,68,.3);color:var(--red);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• FAB â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.fab-wrap{
  position:fixed;bottom:20px;left:0;right:0;
  max-width:420px;margin:0 auto;padding:0 16px;z-index:100;
}
.fab{
  width:100%;display:flex;align-items:center;justify-content:center;gap:10px;
  padding:16px 20px;
  background:linear-gradient(135deg,var(--orange) 0%,var(--orange2) 100%);
  border:none;border-radius:99px;
  color:#fff;font-family:var(--font-title);font-size:1.05rem;font-weight:700;
  cursor:pointer;
  box-shadow:0 8px 32px rgba(249,115,22,.4),0 2px 8px rgba(0,0,0,.4);
  transition:transform .15s,box-shadow .15s,opacity .15s;
  position:relative;overflow:hidden;
  -webkit-tap-highlight-color:transparent;
}
.fab::before{
  content:'';position:absolute;inset:0;
  background:linear-gradient(135deg,rgba(255,255,255,.15) 0%,transparent 60%);
}
.fab:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 12px 40px rgba(249,115,22,.5);}
.fab:active{transform:scale(.97);}
.fab:disabled{opacity:.4;cursor:not-allowed;box-shadow:none;}
.fab-spinner{
  width:20px;height:20px;border:2.5px solid rgba(255,255,255,.3);
  border-top-color:#fff;border-radius:50%;
  animation:spin .7s linear infinite;display:none;
}
.fab.loading .fab-spinner{display:block;}
.fab.loading .fab-icon,.fab.loading .fab-txt{opacity:.5;}
@keyframes spin{to{transform:rotate(360deg)}}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• RESPONSIVE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media(max-width:380px){
  .rb-amount{font-size:2.3rem;}
  .result-detail{grid-template-columns:1fr 1fr;}
  .rd-item:nth-child(2){border-right:none;}
  .rd-item:nth-child(3){border-top:1px solid var(--b1);grid-column:1/-1;padding-left:0;}
}
</style>
</head>
<body>

<div class="wrap">
  <!-- â•â• HEADER â•â• -->
  <header class="hdr">
    <div class="logo-area">
      <div class="logo-brand">
        <img class="logo-img" id="logoImg" src="" alt="Logo">
        <div class="logo" id="logoTexto">Sim<em>PrÃ©stamo</em></div>
      </div>
      <div class="logo-tagline" id="logoTagline">CrÃ©dito rÃ¡pido y transparente</div>
    </div>
    <div class="status-dot ok" id="sdot"></div>
  </header>

  <!-- â•â• HERO â•â• -->
  <div class="hero">
    <div class="hero-eyebrow">Simulador de crÃ©dito</div>
    <h1 class="hero-title">Tu prÃ©stamo<br>en <em>segundos</em></h1>
    <p class="hero-sub">Calcula exactamente cuÃ¡nto pagas, sin sorpresas ni letras pequeÃ±as.</p>
    <div class="hero-stats">
      <div class="hstat"><div class="hstat-val" id="hsCapital">â€”</div><div class="hstat-lbl">Capital mÃ¡x.</div></div>
      <div class="hstat"><div class="hstat-val" id="hsDias">â€”</div><div class="hstat-lbl">Plazos disp.</div></div>
      <div class="hstat"><div class="hstat-val" id="hsTasa">â€”</div><div class="hstat-lbl">Tasa mÃ­n.</div></div>
    </div>
  </div>

  <!-- â•â• SELECTOR PLAZO â•â• -->
  <div class="sel-label">
    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="3" y1="10" x2="21" y2="10"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="16" y1="2" x2="16" y2="6"/></svg>
    Selecciona el plazo
  </div>
  <div class="chips" id="chipsDias">
    <div class="chip-loading"></div><div class="chip-loading"></div>
    <div class="chip-loading"></div><div class="chip-loading"></div>
  </div>

  <!-- â•â• SELECTOR CAPITAL â•â• -->
  <div class="sel-label">
    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
    Selecciona el capital
  </div>
  <div class="chips" id="chipsCapital">
    <div class="chip-loading" style="width:85px"></div><div class="chip-loading" style="width:85px"></div>
    <div class="chip-loading" style="width:85px"></div><div class="chip-loading" style="width:85px"></div>
  </div>

  <!-- â•â• RESULTADO â•â• -->
  <div class="result" id="result">
    <div class="result-banner">
      <div class="rb-label">Total a pagar</div>
      <div class="rb-amount" id="rbTotal"><em>$</em><span id="rbTotalNum">â€”</span></div>
      <div class="rb-pd">Pago diario: <span id="rbPd">â€”</span></div>
    </div>
    <div class="result-detail">
      <div class="rd-item">
        <div class="rd-lbl">Capital</div>
        <div class="rd-val gold" id="rdCapital">â€”</div>
      </div>
      <div class="rd-item">
        <div class="rd-lbl">Plazo</div>
        <div class="rd-val blue" id="rdDias">â€”</div>
      </div>
      <div class="rd-item">
        <div class="rd-lbl">Tasa</div>
        <div class="rd-val orange" id="rdTasa">â€”</div>
      </div>
    </div>
    <div class="result-table">
      <div class="rt-title">Desglose</div>
      <div class="rt-row"><span class="rt-row-key">Capital solicitado</span><span class="rt-row-val gold" id="rtCapital">â€”</span></div>
      <div class="rt-row"><span class="rt-row-key">InterÃ©s total</span><span class="rt-row-val orange" id="rtInteres">â€”</span></div>
      <div class="rt-row"><span class="rt-row-key">InterÃ©s diario</span><span class="rt-row-val orange" id="rtIntDia">â€”</span></div>
      <div class="rt-row"><span class="rt-row-key">Pago diario</span><span class="rt-row-val blue" id="rtPagoDia">â€”</span></div>
    </div>
  </div>

  <!-- Estado vacÃ­o inicial -->
  <div class="empty" id="emptyState">
    <div class="empty-icon">ğŸ’¡</div>
    <div class="empty-txt">Selecciona un plazo y un capital<br>para ver tu simulaciÃ³n al instante.</div>
  </div>

  <!-- Banner de aviso -->
  <div class="info-banner" id="infoBanner">
    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
    <span id="infoBannerTxt"></span>
  </div>

</div><!-- /wrap -->

<!-- FAB -->
<div class="fab-wrap">
  <button class="fab" id="fab" disabled onclick="irASolicitud()">
    <svg class="fab-icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347z"/><path d="M11.5 2C6.261 2 2 6.261 2 11.5c0 1.892.525 3.661 1.435 5.165L2 22l5.487-1.417A9.448 9.448 0 0011.5 21C16.739 21 21 16.739 21 11.5S16.739 2 11.5 2z"/></svg>
    <span class="fab-txt">Solicitar este prÃ©stamo</span>
    <div class="fab-spinner"></div>
  </button>
</div>

<div id="toast"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SHEET_ID   = '19Viesr9Lhy347A9L03J_RuxftUhBduaYsBY206IO6X8';
const APPS_URL   = 'https://script.google.com/macros/s/AKfycbw83md07bzx1UmGRn51i-pRiuvQaEig_mUWS4VjvO0yTIlDCULqT8p3NGsSe2S4nZhzjA/exec';
const ADMIN_FALLBACK = '5214422580524';

const gi = id => document.getElementById(id);
let diasDisp=[], capitalDisp=[], interesMap={};
let selDias=null, selCapital=null;
let adminPhone=ADMIN_FALLBACK;
let _tT;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TOAST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toast(msg, tipo=''){
  clearTimeout(_tT);
  const el=gi('toast'); el.textContent=msg; el.className='show'+(tipo?' '+tipo:'');
  _tT=setTimeout(()=>el.className='',3500);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TEMA DINÃMICO DESDE TelefonoAdmin
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function cargarTema(){
  try{
    const cached = localStorage.getItem('sp_tema');
    if(cached){
      const t = JSON.parse(cached);
      if((Date.now()-t.ts) < 5*60*1000){ aplicarTema(t); return; }
    }
  }catch(e){}

  try{
    const url=`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=TelefonoAdmin&t=${Date.now()}`;
    const txt=await(await fetch(url,{cache:'no-store'})).text();
    const rows=JSON.parse(txt.replace(/^[\s\S]*?setResponse\(/,'').replace(/\);[\s\S]*$/,'')).table?.rows||[];
    for(let i=1;i<rows.length;i++){
      const c=rows[i]?.c||[];
      const activo=String(c[4]?.v||'').toUpperCase()==='TRUE';
      if(!activo)continue;
      const tema = {
        ts:          Date.now(),
        empresa:     String(c[1]?.v||'SimPrÃ©stamo'),
        telefono:    String(c[2]?.v||ADMIN_FALLBACK),
        email:       String(c[3]?.v||''),
        logo:        String(c[5]?.v||''),
        colorPrimario: String(c[6]?.v||'#1a6fd4').trim() || '#1a6fd4',
      };
      localStorage.setItem('sp_tema', JSON.stringify(tema));
      aplicarTema(tema);
      return;
    }
  }catch(e){ console.warn('tema error',e); }
}

function aplicarTema(t){
  // Color primario dinÃ¡mico
  if(t.colorPrimario && /^#[0-9a-fA-F]{6}$/.test(t.colorPrimario)){
    const hex = t.colorPrimario;
    const r=parseInt(hex.slice(1,3),16),g=parseInt(hex.slice(3,5),16),b=parseInt(hex.slice(5,7),16);
    const dark=`#${Math.round(r*.8).toString(16).padStart(2,'0')}${Math.round(g*.8).toString(16).padStart(2,'0')}${Math.round(b*.8).toString(16).padStart(2,'0')}`;
    document.documentElement.style.setProperty('--primary', hex);
    document.documentElement.style.setProperty('--primary2', dark);
    document.documentElement.style.setProperty('--primary3', `rgba(${r},${g},${b},.12)`);
  }

  // Nombre empresa
  if(t.empresa){
    const nombre = t.empresa;
    const mitad  = Math.ceil(nombre.length/2);
    const p1 = nombre.slice(0,mitad), p2 = nombre.slice(mitad);
    gi('logoTexto').innerHTML = `${p1}<em>${p2}</em>`;
    document.title = t.empresa + ' â€” Simulador';
    gi('logoTagline').textContent = 'CrÃ©dito rÃ¡pido y transparente';
  }

  // Logo
  if(t.logo && t.logo.startsWith('http')){
    gi('logoImg').src = t.logo;
    gi('logoImg').classList.add('show');
    gi('logoTexto').style.display = 'none';
  }

  // Guardar telÃ©fono
  if(t.telefono) adminPhone = limpiarTel(t.telefono);
  localStorage.setItem('simulador_admin', JSON.stringify({data:{telefono:adminPhone,email:t.email},ts:Date.now()}));
}

function limpiarTel(tel){
  let t=String(tel).replace(/\D/g,'');
  if(t.startsWith('52')&&t.length===12)return t;
  if(t.length===10)return '52'+t;
  return t||ADMIN_FALLBACK;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CARGAR DATOS SHEET
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function fetchSheet(nombre){
  const url=`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(nombre)}&t=${Date.now()}`;
  const txt=await(await fetch(url,{cache:'no-store'})).text();
  const json=JSON.parse(txt.replace(/^[\s\S]*?setResponse\(/,'').replace(/\);[\s\S]*$/,''));
  return json.table?.rows||[];
}

async function cargarParametros(){
  gi('sdot').className='status-dot busy';
  try{
    // Cache
    const cd=localStorage.getItem('simulador_dias'), cc=localStorage.getItem('simulador_capital'), ci=localStorage.getItem('simulador_interes');
    if(cd&&cc&&ci){
      const td=JSON.parse(cd),tc=JSON.parse(cc),ti=JSON.parse(ci);
      if((Date.now()-td.ts)<5*60*1000){
        diasDisp=td.data; capitalDisp=tc.data; interesMap=ti.data||ti;
        renderChips(); actualizarHeroStats(); gi('sdot').className='status-dot ok'; return;
      }
    }

    const [rowsDias, rowsCap, rowsInt] = await Promise.all([
      fetchSheet('Dias'), fetchSheet('Capital'), fetchSheet('Interes')
    ]);

    diasDisp=[]; for(let i=1;i<rowsDias.length;i++){const v=rowsDias[i]?.c?.[0]?.v;if(v)diasDisp.push(Number(v));}
    capitalDisp=[]; for(let i=1;i<rowsCap.length;i++){const v=rowsCap[i]?.c?.[0]?.v;if(v)capitalDisp.push(Number(v));}
    interesMap={};
    const intVals=[]; for(let i=1;i<rowsInt.length;i++){const v=rowsInt[i]?.c?.[0]?.v;if(v!==undefined&&v!=='')intVals.push(Number(v));}
    diasDisp.forEach((d,i)=>{if(intVals[i]!==undefined)interesMap[d]=intVals[i];});

    const ts=Date.now();
    localStorage.setItem('simulador_dias',JSON.stringify({data:diasDisp,ts}));
    localStorage.setItem('simulador_capital',JSON.stringify({data:capitalDisp,ts}));
    localStorage.setItem('simulador_interes',JSON.stringify({data:interesMap,ts}));

    renderChips(); actualizarHeroStats();
    gi('sdot').className='status-dot ok';

    // Banner
    cargarBanner();
  }catch(e){
    gi('sdot').className='status-dot off';
    toast('Sin conexiÃ³n â€” usando datos guardados','err');
  }
}

async function cargarBanner(){
  try{
    const rows=await fetchSheet('Banner');
    if(rows[1]){
      const activo=String(rows[1]?.c?.[0]?.v||'').toUpperCase()==='TRUE';
      const texto=String(rows[1]?.c?.[1]?.v||'');
      if(activo&&texto){ gi('infoBanner').classList.add('show'); gi('infoBannerTxt').textContent=texto; }
    }
  }catch(e){}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER CHIPS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderChips(){
  // DÃ­as
  gi('chipsDias').innerHTML = diasDisp.map(d=>`
    <div class="chip ${selDias===d?'sel':''}" onclick="selDia(${d})">${d} dÃ­as</div>
  `).join('');
  // Capital
  gi('chipsCapital').innerHTML = capitalDisp.map(c=>`
    <div class="chip ${selCapital===c?'sel':''}" onclick="selCap(${c})">${fmtK(c)}</div>
  `).join('');
}

function actualizarHeroStats(){
  if(capitalDisp.length) gi('hsCapital').textContent = fmtK(Math.max(...capitalDisp));
  if(diasDisp.length)    gi('hsDias').textContent    = diasDisp.length + ' opciones';
  const tasas = Object.values(interesMap);
  if(tasas.length) gi('hsTasa').textContent = Math.min(...tasas)+'%';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SELECCIÃ“N Y CÃLCULO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function selDia(d){
  selDias=d; renderChips();
  if(selCapital) calcular();
}
function selCap(c){
  selCapital=c; renderChips();
  if(selDias) calcular();
}

function calcular(){
  const tasa = interesMap[selDias];
  if(tasa===undefined || !selCapital || !selDias) return;

  const it = selCapital * (tasa/100);
  const tp = selCapital + it;
  const pd = tp / selDias;
  const itDia = it / selDias;

  // Guardar en session
  sessionStorage.setItem('sp_last',JSON.stringify({dias:selDias,capital:selCapital,ip:tasa,it,tp,pd}));
  sessionStorage.setItem('sp_sel',JSON.stringify({dias:selDias,capital:selCapital}));

  // Render
  gi('rbTotalNum').textContent = fmt(tp).replace('$','');
  gi('rbPd').textContent = fmt(pd);
  gi('rdCapital').textContent = fmt(selCapital);
  gi('rdDias').textContent = selDias+' dÃ­as';
  gi('rdTasa').textContent = tasa+'%';
  gi('rtCapital').textContent = fmt(selCapital);
  gi('rtInteres').textContent = fmt(it);
  gi('rtIntDia').textContent = fmt(itDia)+'/dÃ­a';
  gi('rtPagoDia').textContent = fmt(pd);

  gi('result').classList.add('show');
  gi('emptyState').style.display='none';
  gi('fab').disabled=false;

  // Micro haptic
  if(navigator.vibrate) navigator.vibrate(8);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// IR A SOLICITUD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function irASolicitud(){
  if(!selDias||!selCapital){ toast('Selecciona plazo y capital','err'); return; }
  window.location.href='solicitud.html';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FORMAT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function fmt(n){ return '$'+Number(n||0).toLocaleString('es-MX',{minimumFractionDigits:2,maximumFractionDigits:2}); }
function fmtK(n){ return n>=1000?'$'+(n/1000).toFixed(n%1000===0?0:1)+'k':fmt(n); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function init(){
  gi('sdot').className='status-dot '+(navigator.onLine?'ok':'off');
  await cargarTema();
  await cargarParametros();
  window.addEventListener('online',()=>{gi('sdot').className='status-dot busy';cargarParametros();});
  window.addEventListener('offline',()=>gi('sdot').className='status-dot off');
}
init();
</script>
</body>
</html>
